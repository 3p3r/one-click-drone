# one-click-drone

[![Build Status](https://ci.rootstreamapp.com/api/badges/3p3r/one-click-drone/status.svg?ref=refs/heads/master)](https://ci.rootstreamapp.com/3p3r/one-click-drone)

**Launch in your AWS account:**<br /><a target="_blank" href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/template?templateURL=https%3A%2F%2Fone-click-drone.s3-us-west-2.amazonaws.com%2Focd.yml"><span><img height="24px" src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/></span></a>

One click deploy of [Drone CI](https://drone.io/) into your AWS account.

This project was made out of my personal frustration with people's crappy Drone CI setups, half-assed entirely useless
Medium articles and broken CloudFormation scripts all around the Internet. It seems like nobody wants to put down the
time to properly set up a CI installation for their projects. Either that, or nobody bothers open sourcing it!

## features

:heavy_check_mark: Support for **Drone CI version 1.0**<br />
:heavy_check_mark: Customizeable **CloudFormation** generated by **AWS CDK**<br />
:heavy_check_mark: Drone Server agents running on **Fargate** with auto-scaling<br />
:heavy_check_mark: Drone Docker Runner daemons running on **ECS** with auto-scaling<br />
:heavy_check_mark: Integrated with **Serverless Aurora** for Drone's PostgreSQL database<br />
:heavy_check_mark: Shared **EFS volume** cache for all the runner daemons and accessible to build jobs<br />
:heavy_check_mark: Using **CloudFront** to support custom domain and HTTP caching in front of Drone<br />
:heavy_check_mark: Runner build logs storage on **S3** to save on database costs and better logs accessibility<br />
:heavy_check_mark: Runner and Server agent logs storage on **CloudWatch** for diagnosis and debugging<br />
:heavy_check_mark: Cache cleaner **ECS task** script to keep EFS usage and costs at minimum<br />
:heavy_check_mark: Support for **custom AMIs** running Drone Docker Runners<br />

## usage

Just click on the _Launch Stack_ button above and it should take you to your AWS account login. After logging in, you should see CloudFormation console's _Create Stack_ page with the template of this project already filled in for you. You may click on _Next_ and modify the parameters. For an explanation of what these parameters are, read the next section of this document.

The CloudFormation file under `dist/ocd.yml` is auto generated from CDK scripts under `lib/*.js`. You need to be familiar with AWS CDK if you want to modify the CloudFormation file.

## parameters

### RunnerInstanceType (default: `t2.micro`)

EC2 instance type of Drone Docker Runner agents.

### DatabaseUsername (you must set this)

Database username used by Drone server agents. You can generate a random one by executing `openssl rand -hex 16` in your terminal. Must be at least 8 characters. Refer to AWS documentation on Serverless Aurora PostgreSQL for constraints.

### DatabasePassword (you must set this)

Database password used by Drone server agents. You can generate a random one by executing `openssl rand -hex 16` in your terminal. Must be at least 8 characters. Refer to AWS documentation on Serverless Aurora PostgreSQL for constraints.

### DatabaseSecret (default: `change-this-secret`)

Database secret used by Drone server agents to encrypt Drone secrets (DRONE_DATABASE_SECRET). You can generate a random one by executing `openssl rand -hex 16` in your terminal. Must be at least 8 characters.

### RunnerContainer (default: `drone/drone-runner-docker:1`)

Drone docker runner container name and version used.

### RunnerJobCapacity (default: `10`)

Max number of build jobs a single runner container accepts (DRONE_RUNNER_CAPACITY).

### RunnerMaxCapacity (default: `2`)

Drone docker runner service auto-scaler limit. This is the maximum number of EC2 instances that'll launch for you to host Docker runner daemons if all of them hit 90% cpu usage.

### ServerContainer (default: `drone/drone:1`)

Drone server container name and version used.

### ServerRpcSecret (default: `change-this-secret`)

Drone shared RPC secret used across all runners and servers (DRONE_RPC_SECRET). You can generate a random one by executing `openssl rand -hex 16` in your terminal. Must be at least 8 characters.

### ServerRepoFilter (default: no filters)

Drone repository filter (DRONE_REPOSITORY_FILTER).

### ServerMaxCapacity (default: `2`)

Drone server service auto-scaler limit. This is the maximum number of Fargate tasks running the server agents.

### ServerCookieSecret (default: `change-this-secret`)

Drone server secret key used to sign authentication cookies (DRONE_COOKIE_SECRET).

### ServerAdmin (default: no admin, you should set this)

Drone server admin user (created only during the initial deploy - DRONE_USER_CREATE). Without this, you will not have an admin user and cannot make trusted builds.

### ServerDomain (default: one will be generated for you through CloudFront)

If you have a custom CNAME (e.g. `ci.example.com`), specify it here. Otherwise a domain will be autogenerated for you. If you set this, you must manually perform the following tasks to get your Drone CI working:

1. Provision a certificate for this domain in the `us-east-1` (N. Virginia) region
1. Associate the certificate with the deployed CloudFront distribution
   - CloudFront console > Distributions > `one-click-drone dist ID` > Edit > Custom SSL Certificate
   - See [CloudFront docs](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cnames-and-https-procedures.html) for details.
1. Associate your domain with the deployed CloudFront distribution - CloudFront console > Distributions > `one-click-drone dist ID` > Edit > Alternate Domain Names  
   (CNAMEs) - See [CloudFront docs](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cnames-and-https-procedures.html) for details.

Also make sure your [Github OAuth app](<[https://github.com/settings/apps](https://github.com/settings/apps)>) is pointing to your domain and not CloudFront.

### GithubServer (default: `https://github.com`)

Github server used. Change this if using Github enterprise.

### GithubClientId (default: `change-this-secret`)

Github app OAuth clientId (DRONE_GITHUB_CLIENT_ID). You can obtain this here: https://github.com/settings/apps.

### GithubClientSecret (default: `change-this-secret`)

Github app OAuth clientSecret (DRONE_GITHUB_CLIENT_SECRET). You can obtain this here: https://github.com/settings/apps.

### CacheCleanerRate (default: `1 day`)

The rate at which the cache cleaner runs (CloudWatch rate expression).

### CacheTTLInDays (default: `7`)

Cache files older than this number of days are deleted at "CacheCleanerRate" intervals.
